=AND(IF(AO2, AND(IF(AQ2=1, IF(AR2=0, AND(S2>1.1, IF(R2<=30, S2>=1.4, S2>=1.2)), S2>=10), TRUE), IF(AS2=0, AND(U2>1.1, IF(T2<=30, U2>=1.4, U2>=1.2)), TRUE)), TRUE), IF(AV2, AND(IF(BC2=1, IF(BD2=0, AND(S2>1.1, IF(R2<=30, S2>=1.4, S2>=1.2)), S2>=10), TRUE), IF(BE2=0, AND(U2>1.1, IF(T2<=30, U2>=1.4, U2>=1.2)), TRUE)), TRUE), IF(BG2, AND(IF(BK2=1, IF(BL2=0, AND(S2>1.1, IF(R2<=30, S2>=1.4, S2>=1.2)), S2>=10), TRUE), IF(BM2=0, AND(U2>1.1, IF(T2<=30, U2>=1.4, U2>=1.2)), TRUE)), TRUE), IF(BO2, AND(IF(BS2=1, IF(BT2=0, AND(S2>1.1, IF(R2<=30, S2>=1.4, S2>=1.2)), S2>=10), TRUE), IF(BU2=0, AND(U2>1.1, IF(T2<=30, U2>=1.4, U2>=1.2)), TRUE)), TRUE))














Sub GenerateSetFile_Final()
    ' Version 4 - Fully self-contained and robust against copy-paste errors.
    
    ' --- Step 1: Define paths and check selection ---
    Dim desktopPath As String
    desktopPath = Environ("USERPROFILE") & "\Desktop"
    
    Dim outputFolderPath As String
    outputFolderPath = desktopPath & "\SetFiles\"

    On Error Resume Next
    MkDir outputFolderPath
    On Error GoTo 0

    If ActiveCell Is Nothing Or ActiveCell.Row <= 1 Then
        MsgBox "Error: Please select a cell in a data row first.", vbCritical, "Selection Error"
        Exit Sub
    End If

    Dim selectedRow As Long
    selectedRow = ActiveCell.Row
    
    Dim ws As Worksheet
    Set ws = ActiveSheet
    
    ' --- Step 2: Load Excel row data into a Dictionary for fast lookup ---
    Dim paramsFromExcel As Object
    Set paramsFromExcel = CreateObject("Scripting.Dictionary")
    paramsFromExcel.CompareMode = 1 ' Case-insensitive compare
    
    Dim lastCol As Long
    lastCol = ws.Cells(1, ws.Columns.Count).End(xlToLeft).Column
    Dim i As Long
    
    For i = 1 To lastCol
        Dim headerName As String
        headerName = CStr(ws.Cells(1, i).Value)
        paramsFromExcel(headerName) = CStr(ws.Cells(selectedRow, i).Value)
    Next i

    ' --- Step 3: Build the template string directly ---
    Dim newSetContent As String
    newSetContent = ""
    newSetContent = newSetContent & "; Automatically Generated by Gemini for Mohammad" & vbCrLf
    newSetContent = newSetContent & "; Pass Number: " & paramsFromExcel("Pass") & vbCrLf
    newSetContent = newSetContent & ";" & vbCrLf
    newSetContent = newSetContent & "; --- Major Engine Settings ---" & vbCrLf
    newSetContent = newSetContent & "Maj_EnableTrading=" & paramsFromExcel("Maj_EnableTrading") & "||false||0||true||N" & vbCrLf
    newSetContent = newSetContent & "Maj_DrawGraphics=" & paramsFromExcel("Maj_DrawGraphics") & "||false||0||true||N" & vbCrLf
    ' ... Add ALL other parameters here one by one ...
    ' This is an example for a few parameters. The full list is very long.
    ' I will use a more generic approach to build the string from the provided template to avoid hardcoding all 70+ lines.

    ' --- A more robust way to build the string ---
    Dim fullTemplate As String
    fullTemplate = GetFullTemplateString()
    
    Dim lines() As String
    lines = Split(fullTemplate, vbCrLf)
    
    Dim finalContent As String
    finalContent = "; Automatically Generated by Gemini for Mohammad" & vbCrLf
    finalContent = finalContent & "; Pass Number: " & paramsFromExcel("Pass") & vbCrLf
    
    Dim line As Variant
    Dim paramName As String
    Dim parts() As String
    
    For Each line In lines
        If InStr(line, "=") > 0 And Left(line, 1) <> ";" Then
            paramName = Trim(Split(line, "=")(0))
            
            ' Check if the parameter from template exists in the Excel headers
            If paramsFromExcel.Exists(paramName) Then
                parts = Split(line, "||")
                parts(0) = paramName & "=" & paramsFromExcel(paramName)
                finalContent = finalContent & Join(parts, "||") & vbCrLf
            Else
                finalContent = finalContent & line & vbCrLf ' Keep original template line if not found in Excel
            End If
        Else
            finalContent = finalContent & line & vbCrLf ' Keep comment/empty lines
        End If
    Next line
    
    ' --- Step 4: Save the new .set file automatically ---
    Dim outputFilePath As String
    outputFilePath = outputFolderPath & "Pass_" & paramsFromExcel("Pass") & ".set"

    Dim fileNum As Integer
    fileNum = FreeFile
    Open outputFilePath For Output As #fileNum
    Print #fileNum, finalContent
    Close #fileNum
    
    MsgBox "Set file for Pass #" & paramsFromExcel("Pass") & " was created successfully.", vbInformation, "Success"

End Sub

Function GetFullTemplateString() As String
    ' This function holds the entire .set file structure with correct parameter names
    Dim s As String
    s = ""
    s = s & "; --- Major Engine Settings (Macro Analysis) ---" & vbCrLf
    s = s & "Maj_EnableTrading=true||false||0||true||N" & vbCrLf
    s = s & "Maj_DrawGraphics=false||false||0||true||N" & vbCrLf
    s = s & "Maj_EnableLogs=false||false||0||true||N" & vbCrLf
    s = s & "Maj_TF_Strategic=16396||0||0||16408||Y" & vbCrLf
    s = s & "Maj_TF_Tactical=6||0||0||16408||Y" & vbCrLf
    s = s & "Maj_BarsToScan=500||500||1||5000||N" & vbCrLf
    s = s & "; --- Fibonacci & Trade Permit Settings ---" & vbCrLf
    s = s & "Maj_FibLevelsString=0.0,0.5,0.618,1.0" & vbCrLf
    s = s & "Maj_BarsToScanForFibo100=2500||250||1||2500||N" & vbCrLf
    s = s & "Maj_FibLevelThreshold=0.50||0.1||0.05||0.8||N" & vbCrLf
    s = s & "Maj_FlagExpirationMode=1||0||0||1||Y" & vbCrLf
    s = s & "; --- Main Peak/Valley Settings (Merit Logic) ---" & vbCrLf
    s = s & "Maj_MainPeakValleyMode=0||0||0||1||N" & vbCrLf
    s = s & "Maj_MeritCeilingsInBetween=1||1||1||5||N" & vbCrLf
    s = s & "Maj_MeritValleysInBetween=2||2||1||5||N" & vbCrLf
    s = s & "Maj_MeritValleysInBetween_V=1||1||1||5||N" & vbCrLf
    s = s & "Maj_MeritCeilingsInBetween_V=2||2||1||5||N" & vbCrLf
    s = s & "Maj_MeritLogic=5||0||0||5||Y" & vbCrLf
    s = s & "; --- Structure Break Settings ---" & vbCrLf
    s = s & "Maj_BreakType=1||0||0||1||Y" & vbCrLf
    s = s & "Maj_ConfirmationCandles=5||2||1||8||Y" & vbCrLf
    s = s & "; --- Strategic Fineflow Settings (Major Engine) ---" & vbCrLf
    s = s & "Maj_Strat_EnforceStrictSequence=true||false||0||true||Y" & vbCrLf
    s = s & "Maj_Strat_DetectionMethod=0||0||0||5||Y" & vbCrLf
    s = s & "Maj_Strat_Lookback=4||3||1||10||N" & vbCrLf
    s = s & "Maj_Strat_SequentialLookback=2||2||1||10||N" & vbCrLf
    s = s & "Maj_Strat_UseStrictSequential=true||false||0||true||N" & vbCrLf
    s = s & "Maj_Strat_SequentialCriterion=0||0||0||3||N" & vbCrLf
    s = s & "Maj_Strat_AtrPeriod=14||5||1||140||N" & vbCrLf
    s = s & "Maj_Strat_AtrMultiplier=2.5||1.5||0.250000||25.000000||N" & vbCrLf
    s = s & "Maj_Strat_ZigZagDepth=12||10||1||120||N" & vbCrLf
    s = s & "Maj_Strat_ZigZagDeviation=5||5.0||0.500000||50.000000||N" & vbCrLf
    s = s & "; --- Tactical Fineflow Settings (Major Engine) ---" & vbCrLf
    s = s & "Maj_Tac_EnforceStrictSequence=false||false||0||true||Y" & vbCrLf
    s = s & "Maj_Tac_DetectionMethod=3||0||0||5||Y" & vbCrLf
    s = s & "Maj_Tac_Lookback=3||3||1||10||N" & vbCrLf
    s = s & "Maj_Tac_SequentialLookback=2||2||1||10||N" & vbCrLf
    s = s & "Maj_Tac_UseStrictSequential=true||false||0||true||N" & vbCrLf
    s = s & "Maj_Tac_SequentialCriterion=0||0||0||3||N" & vbCrLf
    s = s & "Maj_Tac_AtrPeriod=14||14||1||140||N" & vbCrLf
    s = s & "Maj_Tac_AtrMultiplier=2.5||2.5||0.250000||25.000000||N" & vbCrLf
    s = s & "Maj_Tac_ZigZagDepth=12||12||1||120||N" & vbCrLf
    s = s & "Maj_Tac_ZigZagDeviation=5||5.0||0.500000||50.000000||N" & vbCrLf
    s = s & "; --- 1. General Trade Management Settings ---" & vbCrLf
    s = s & "InpEnableSmartManagement=true||false||0||true||N" & vbCrLf
    s = s & "InpBreakevenTarget_R=1.5||1.0||0.1||10.0||N" & vbCrLf
    s = s & "InpEnablePartialProfit=false||false||0||true||N" & vbCrLf
    s = s & "InpPartialProfitTarget_R=2.5||1.0||0.15||5.0||N" & vbCrLf
    s = s & "InpPartialProfit_Percent=30||10.0||5.0||70.0||N" & vbCrLf
    s = s & "; --- 2. Trailing Stop Settings ---" & vbCrLf
    s = s & "InpEnableTrailingStop=true||false||0||true||N" & vbCrLf
    s = s & "InpTrailingMethod=0||0||0||2||Y" & vbCrLf
    s = s & "InpTrailingStopFloor=1||0||0||1||N" & vbCrLf
    s = s & "InpTrail_ATR_Period=77||1||1||140||N" & vbCrLf
    s = s & "InpTrail_ATR_Multiplier=18.60||0.1||0.25||25.0||N" & vbCrLf
    s = s & "InpTrail_Fixed_Distance_Pips=1585||100||1||2000||N" & vbCrLf
    s = s & "; --- Trailing Fineflow Settings ---" & vbCrLf
    s = s & "InpTrail_Fineflow_TF=1||0||0||49153||Y" & vbCrLf
    s = s & "trail_Strat_EnforceStrictSequence=false||false||0||true||N" & vbCrLf
    s = s & "trail_Strat_DetectionMethod=1||0||0||5||Y" & vbCrLf
    s = s & "trail_Strat_Lookback=18||3||1||30||Y" & vbCrLf
    s = s & "trail_Strat_SequentialLookback=2||2||1||20||N" & vbCrLf
    s = s & "trail_Strat_UseStrictSequential=true||false||0||true||N" & vbCrLf
    s = s & "trail_Strat_SequentialCriterion=0||0||0||3||N" & vbCrLf
    s = s & "trail_Strat_AtrPeriod=14||14||1||140||N" & vbCrLf
    s = s & "trail_Strat_AtrMultiplier=2.5||2.5||0.250000||25.000000||N" & vbCrLf
    s = s & "trail_Strat_ZigZagDepth=12||12||1||120||N" & vbCrLf
    s = s & "trail_Strat_ZigZagDeviation=5||5.0||0.500000||50.000000||N" & vbCrLf
    s = s & "; General Strategy Settings" & vbCrLf
    s = s & "InpStrategyMode=1||0||0||1||N" & vbCrLf
    s = s & "; General Trade Settings" & vbCrLf
    s = s & "InpMagicNumber=124568||124568||1||1245680||N" & vbCrLf
    s = s & "LotSize=0.1||0.1||0.010000||1.000000||N" & vbCrLf
    s = s & "UseAutoLot=true||false||0||true||N" & vbCrLf
    s = s & "RiskPercent=1||0.2||0.1||2.0||N" & vbCrLf
    s = s & "DefaultStopLossPip=25||15.0||1.500000||50||N" & vbCrLf
    s = s & "TakeProfitRatio=4||2.0||0.2||10.0||N" & vbCrLf
    s = s & "EnableAutoTrading=true||false||0||true||N" & vbCrLf
    s = s & "MaxConcurrentTrades=3||1||1||5||N" & vbCrLf
    s = s & "AllowHedge=false||false||0||true||N" & vbCrLf
    s = s & "SPR=23||3||1||30||N" & vbCrLf
    s = s & "MAX_CANDLES_VALIDITY=500||500||1||5000||N" & vbCrLf
    s = s & "; Fineflow Settings (Middle TF)" & vbCrLf
    s = s & "EnforceStrictSequence=true||false||0||true||N" & vbCrLf
    s = s & "DetectionMethod=1||0||0||3||Y" & vbCrLf
    s = s & "TF=0||0||0||49153||N" & vbCrLf
    s = s & "Lookback=4||3||1||10||Y" & vbCrLf
    s = s & "SequentialLookback=2||2||1||10||N" & vbCrLf
    s = s & "UseStrictSequential=true||false||0||true||N" & vbCrLf
    s = s & "SequentialCriterion=0||0||0||3||N" & vbCrLf
    s = s & "AtrPeriod=14||14||1||140||N" & vbCrLf
    s = s & "AtrMultiplier=2.5||2.5||0.250000||25.000000||N" & vbCrLf
    s = s & "ZigZagDepth=12||12||1||120||N" & vbCrLf
    s = s & "ZigZagDeviation=5||5.0||0.500000||50.000000||N" & vbCrLf
    s = s & "; Fineflow Settings (Strategic TF)" & vbCrLf
    s = s & "EnforceStrictSequenceT2=true||false||0||true||N" & vbCrLf
    s = s & "DetectionMethod_Time2=0||0||0||5||Y" & vbCrLf
    s = s & "TF_Time2=16385||0||0||16385||Y" & vbCrLf
    s = s & "Lookback_Time2=5||3||1||10||Y" & vbCrLf
    s = s & "SequentialLookback_Time2=2||2||1||10||N" & vbCrLf
    s = s & "UseStrictSequential_Time2=true||false||0||true||N" & vbCrLf
    s = s & "SequentialCriterion_Time2=0||0||0||3||N" & vbCrLf
    s = s & "AtrPeriod_Time2=14||14||1||140||N" & vbCrLf
    s = s & "AtrMultiplier_Time2=10.25||2.5||0.25||25.0||N" & vbCrLf
    s = s & "ZigZagDepth_Time2=37||12||1||120||N" & vbCrLf
    s = s & "ZigZagDeviation_Time2=46.0||5.0||0.5||50.0||N" & vbCrLf
    s = s & "; Flip_Fineflow Settings" & vbCrLf
    s = s & "EnforceStrictSequenceflip=true||false||0||true||N" & vbCrLf
    s = s & "flipDetectionMethod=0||0||0||3||N" & vbCrLf
    s = s & "flipLookback=4||3||1||30||N" & vbCrLf
    s = s & "; Main Peak/Valley Settings" & vbCrLf
    s = s & "MainPeakValleyMode=1||0||0||1||N" & vbCrLf
    s = s & "InpMeritCeilingsInBetween=1||1||1||5||N" & vbCrLf
    s = s & "InpMeritValleysInBetween=2||2||1||5||N" & vbCrLf
    s = s & "InpMeritValleysInBetween_V=1||1||1||5||N" & vbCrLf
    s = s & "InpMeritCeilingsInBetween_V=2||2||1||5||N" & vbCrLf
    s = s & "InpMeritLogic=1||0||0||5||Y" & vbCrLf
    s = s & "; Structure Break Settings" & vbCrLf
    s = s & "BreakType=0||0||0||1||Y" & vbCrLf
    s = s & "ConfirmationCandles=6||2||1||10||Y" & vbCrLf
    s = s & "; Pinbar Settings" & vbCrLf
    s = s & "Timeframes=M2,M3,M5,M4" & vbCrLf
    s = s & "EnableMultiTimeframe=true||false||0||true||N" & vbCrLf
    s = s & "PinbarBodyRatio=0.5||0.1||0.05||1.0||N" & vbCrLf
    s = s & "inputbodyRatio=3||1||1||5||N" & vbCrLf
    s = s & "MaxDistanceFromLine=50||1.0||5.5||100.0||N" & vbCrLf
    s = s & "MaxPinbarCandles=1||1||1||10||Y" & vbCrLf
    s = s & "InpEnableSinglePinbar=true||false||0||true||N" & vbCrLf
    s = s & "InpEnableMultiPinbar=true||false||0||true||N" & vbCrLf
    s = s & "InpMaxCandleCombine=3||2||1||7||N" & vbCrLf
    s = s & "; Pinbar Filter Settings" & vbCrLf
    s = s & "FilterPinbarDirection=true||false||0||true||N" & vbCrLf
    s = s & "InpPinbarDirectionLogic=2||0||0||2||N" & vbCrLf
    s = s & "RequireLiquiditySweep=true||false||0||true||N" & vbCrLf
    s = s & "; ATR Stop Loss Settings" & vbCrLf
    s = s & "StopLossMode=0||0||0||1||Y" & vbCrLf
    s = s & "InpAtrPeriod=41||1||1||140||N" & vbCrLf
    s = s & "InpAtrMultiplier=2||0.1||0.2||20.0||N" & vbCrLf
    s = s & "; Flip Source Settings" & vbCrLf
    s = s & "FlipSource=0||0||0||1||Y" & vbCrLf
    s = s & "; Line Validity Settings" & vbCrLf
    s = s & "InpLineValidityTimeframe=1||0||0||2||Y" & vbCrLf
    s = s & "; Graphical Display Settings" & vbCrLf
    s = s & "ShowOrderBlocks=true||false||0||true||N" & vbCrLf
    s = s & "ShowDrawLines=true||false||0||true||N" & vbCrLf
    s = s & "ShowFlipLines=true||false||0||true||N" & vbCrLf
    s = s & "InpShowEntryArrow=false||false||0||true||N" & vbCrLf
    s = s & "InpShowBreakLines=false||false||0||true||N" & vbCrLf
    s = s & "InpZonebackgrandColor=8421504" & vbCrLf
    s = s & "; Session Filter Settings" & vbCrLf
    s = s & "EnableSessionFilter=true||false||0||true||N" & vbCrLf
    s = s & "SessionStartHour=4||7||1||70||N" & vbCrLf
    s = s & "SessionStartMinute=30||59||1||590||N" & vbCrLf
    s = s & "SessionEndHour=21||18||1||180||N" & vbCrLf
    s = s & "SessionEndMinute=59||59||1||590||N" & vbCrLf
    s = s & "; Custom Optimization Settings" & vbCrLf
    s = s & "InpMinTradesPerYear=40||30||1||300||N" & vbCrLf
    s = s & "InpMaxAcceptableDrawdown=20||15||1||150||N"
    GetFullTemplateString = s
End Function





































