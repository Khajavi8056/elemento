' VBA Code Updated for Elemento EA
' Version 3.0 - Dynamic .set file generation by Gemini for Mohammad
' This macro dynamically reads ONLY the optimized parameters from Excel and generates a clean .set file.

' Tabe' asli ke ba feshordan Alt+F8 ejra mishavad
Sub GenerateElementoSetFile_Dynamic()
    On Error GoTo ErrorHandler

    ' --- Ghadam 1: Ta'rife masir-ha va check kardan-e selloul-e entekhab shode ---
    Dim desktopPath As String
    desktopPath = Environ("USERPROFILE") & "\Desktop"
    
    Dim elementoFolderPath As String
    elementoFolderPath = desktopPath & "\Elemento\"
    
    Dim outputFolderPath As String
    outputFolderPath = elementoFolderPath & "SetFiles\"

    ' Sakht-e pushe-ha dar surat-e adam-e vujud
    If Dir(elementoFolderPath, vbDirectory) = "" Then MkDir elementoFolderPath
    If Dir(outputFolderPath, vbDirectory) = "" Then MkDir outputFolderPath

    ' Check kardan-e inke aya yek selloul-e mo'tabar entekhab shode ast
    If ActiveCell Is Nothing Or ActiveCell.Row <= 1 Then
        MsgBox "Khata: Lotfan ebteda yek selloul dar yeki az radif-haye natayej ra entekhab konid.", vbCritical, "Khataye Entekhab"
        Exit Sub
    End If

    Dim selectedRow As Long
    selectedRow = ActiveCell.Row
    
    Dim ws As Worksheet
    Set ws = ActiveSheet
    
    Dim passNumber As String
    passNumber = CStr(ws.Cells(selectedRow, "A").Value) ' Pass number is always in column A

    ' --- Ghadam 2: Sakht-e mohtava-ye file .set به صورت پویا ---
    Dim finalContent As String
    finalContent = "; Automatically Generated by Elemento EA Smart Macro" & vbCrLf
    finalContent = finalContent & "; Source Pass Number: " & passNumber & vbCrLf & vbCrLf
    
    Dim lastCol As Long
    lastCol = ws.Cells(1, ws.Columns.Count).End(xlToLeft).Column
    Dim i As Long
    Dim headerName As String
    Dim cellValue As String
    
    ' Halghe baraye khandan-e tamam-e sotun-ha va sakht-e file .set
    For i = 1 To lastCol
        headerName = CStr(ws.Cells(1, i).Value)
        
        ' Inja filter-e هوشمند anjam mishe:
        ' Faghat sotun-haei ke esmeshun ba "Inp" shoru mishe ro dar nazar begir
        If Left(headerName, 3) = "Inp" Then
            cellValue = CStr(ws.Cells(selectedRow, i).Value)
            finalContent = finalContent & headerName & "=" & cellValue & vbCrLf
        End If
    Next i

    ' --- Ghadam 3: Zakhire-ye file .set nahaee ---
    Dim outputFilePath As String
    outputFilePath = outputFolderPath & "Pass_" & passNumber & ".set"

    Dim fileNum As Integer
    fileNum = FreeFile
    Open outputFilePath For Output As #fileNum
    Print #fileNum, finalContent
    Close #fileNum
    
    MsgBox "File .set baraye Pass shomare " & passNumber & " ba movaffaghiat dar Desktop shoma (pushe Elemento\SetFiles) sakhte shod.", vbInformation, "Amaliat Movaffagh"
    Exit Sub

ErrorHandler:
    MsgBox "Yek khataye pishbini nashode rokh dad: " & vbCrLf & Err.Description, vbCritical, "Khata"
End Sub
