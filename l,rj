=AND(IF(AO2, AND(IF(AQ2=1, IF(AR2=0, AND(S2>1.1, IF(R2<=30, S2>=1.4, S2>=1.2)), S2>=10), TRUE), IF(AS2=0, AND(U2>1.1, IF(T2<=30, U2>=1.4, U2>=1.2)), TRUE)), TRUE), IF(AV2, AND(IF(BC2=1, IF(BD2=0, AND(S2>1.1, IF(R2<=30, S2>=1.4, S2>=1.2)), S2>=10), TRUE), IF(BE2=0, AND(U2>1.1, IF(T2<=30, U2>=1.4, U2>=1.2)), TRUE)), TRUE), IF(BG2, AND(IF(BK2=1, IF(BL2=0, AND(S2>1.1, IF(R2<=30, S2>=1.4, S2>=1.2)), S2>=10), TRUE), IF(BM2=0, AND(U2>1.1, IF(T2<=30, U2>=1.4, U2>=1.2)), TRUE)), TRUE), IF(BO2, AND(IF(BS2=1, IF(BT2=0, AND(S2>1.1, IF(R2<=30, S2>=1.4, S2>=1.2)), S2>=10), TRUE), IF(BU2=0, AND(U2>1.1, IF(T2<=30, U2>=1.4, U2>=1.2)), TRUE)), TRUE))











' VBA Code Updated for Elemento EA
' Version 2.1 - Finglish Comments by Gemini for Mohammad
' This macro reads a row from the optimization results and generates a .set file.

' Tabe' asli ke ba feshordan Alt+F8 ejra mishavad
Sub GenerateElementoSetFile()
    On Error GoTo ErrorHandler

    ' --- Ghadam 1: Ta'rife masir-ha va check kardan-e selloul-e entekhab shode ---
    Dim desktopPath As String
    desktopPath = Environ("USERPROFILE") & "\Desktop"
    
    Dim elementoFolderPath As String
    elementoFolderPath = desktopPath & "\Elemento\"
    
    Dim outputFolderPath As String
    outputFolderPath = elementoFolderPath & "SetFiles\"

    ' Sakht-e pushe-ha dar surat-e adam-e vujud
    If Dir(elementoFolderPath, vbDirectory) = "" Then MkDir elementoFolderPath
    If Dir(outputFolderPath, vbDirectory) = "" Then MkDir outputFolderPath

    ' Check kardan-e inke aya yek selloul-e mo'tabar entekhab shode ast
    If ActiveCell Is Nothing Or ActiveCell.Row <= 1 Then
        MsgBox "Khata: Lotfan ebteda yek selloul dar yeki az radif-haye natayej ra entekhab konid.", vbCritical, "Khataye Entekhab"
        Exit Sub
    End If

    Dim selectedRow As Long
    selectedRow = ActiveCell.Row
    
    Dim ws As Worksheet
    Set ws = ActiveSheet
    
    ' --- Ghadam 2: Khandan-e dade-haye radif-e entekhab shode Excel dar hafeze (Dictionary) ---
    Dim paramsFromExcel As Object
    Set paramsFromExcel = CreateObject("Scripting.Dictionary")
    paramsFromExcel.CompareMode = 1 ' Jostoju-ye gheir-hassas be horuf-e bozorg va kuchak
    
    Dim lastCol As Long
    lastCol = ws.Cells(1, ws.Columns.Count).End(xlToLeft).Column
    Dim i As Long
    
    ' Halghe baraye khandan-e tamam-e sotun-ha az radif-e entekhab shode
    For i = 1 To lastCol
        Dim headerName As String
        headerName = CStr(ws.Cells(1, i).Value)
        If headerName <> "" Then
            paramsFromExcel(headerName) = CStr(ws.Cells(selectedRow, i).Value)
        End If
    Next i

    ' --- Ghadam 3: Sakht-e mohtava-ye file .set bar asas-e ghaleb va jaygozini-e maghadir ---
    Dim templateString As String
    templateString = GetElementoTemplateString() ' Gereftan-e ghaleb-e kamel az tabe' komaki
    
    Dim lines() As String
    lines = Split(templateString, vbCrLf) ' Shekastan-e ghaleb be khotut-e mojaza
    
    Dim finalContent As String
    finalContent = "; Automatically Generated by Gemini for Mohammad's Elemento EA" & vbCrLf
    finalContent = finalContent & "; Source Pass Number: " & paramsFromExcel("Pass") & vbCrLf & vbCrLf
    
    Dim line As Variant
    Dim paramName As String
    
    ' Halghe baraye obur az har khat-e ghaleb
    For Each line In lines
        If InStr(line, "=") > 0 And Left(line, 1) <> ";" Then ' Agar khat havi-ye parameter bashad
            paramName = Trim(Split(line, "=")(0))
            
            ' Check kardan-e inke aya in parameter dar natayej-e Excel ma vujud darad ya na
            If paramsFromExcel.Exists(paramName) Then
                ' Agar vujud dasht, meghdar-e an ra az Excel jaygozin kon
                finalContent = finalContent & paramName & "=" & paramsFromExcel(paramName) & vbCrLf
            Else
                ' Agar vujud nadasht, haman khat-e pishfarz-e ghaleb ra negah dar
                finalContent = finalContent & line & vbCrLf
            End If
        Else
            ' Khotut-e khali ya comment-ha ra hamantor ke hast, ezafe kon
            finalContent = finalContent & line & vbCrLf
        End If
    Next line
    
    ' --- Ghadam 4: Zakhire-ye file .set nahaee ---
    Dim outputFilePath As String
    outputFilePath = outputFolderPath & "Pass_" & paramsFromExcel("Pass") & ".set"

    Dim fileNum As Integer
    fileNum = FreeFile
    Open outputFilePath For Output As #fileNum
    Print #fileNum, finalContent
    Close #fileNum
    
    MsgBox "File .set baraye Pass shomare " & paramsFromExcel("Pass") & " ba movaffaghiat dar Desktop shoma (pushe Elemento\SetFiles) sakhte shod.", vbInformation, "Amaliat Movaffagh"
    Exit Sub

ErrorHandler:
    MsgBox "Yek khataye pishbini nashode rokh dad: " & vbCrLf & Err.Description, vbCritical, "Khata"
End Sub

' In tabe', ghaleb-e kamel va pishfarz-e file .set baraye expert Elemento ra negahdari mikonad
Private Function GetElementoTemplateString() As String
    Dim s As String
    s = ""
    s = s & "; --- Tanzimat-e Omumi ---" & vbCrLf
    s = s & "InpBaseMagicNumber=123456" & vbCrLf
    s = s & "InpRiskPercent=1.0" & vbCrLf
    s = s & "InpDebugMode=true" & vbCrLf
    s = s & "Inp_Invalidation_Mode=0" & vbCrLf
    s = s & "Inp_Confirmation_Strategy=1" & vbCrLf
    s = s & "Inp_Confirmation_Timeout=3" & vbCrLf
    s = s & "Inp_PriceConfirmation_Enabled=true" & vbCrLf
    s = s & "Inp_MinRangePoints=50" & vbCrLf
    s = s & "Inp_MaxRangePoints=1500" & vbCrLf
    s = s & "Inp_Placement_ATR_Period=14" & vbCrLf
    s = s & "Inp_Placement_ATR_Multiplier=1.0" & vbCrLf
    s = s & "Inp_Placement_Percent_Value=0.5" & vbCrLf
    s = s & "Inp_SL_ATR_Period=14" & vbCrLf
    s = s & "Inp_SL_ATR_Multiplier=1.5" & vbCrLf
    s = s & "Inp_Trailing_ATR_Period=14" & vbCrLf
    s = s & "Inp_Trailing_ATR_Multiplier=2.0" & vbCrLf
    s = s & "Inp_RR_Ratio=1.5" & vbCrLf
    s = s & "Inp_PartialClosePercent=50.0" & vbCrLf
    s = s & "Inp_Pullback_StopBuffer_Points=5" & vbCrLf
    s = s & "Inp_BE_Buffer_Points=5" & vbCrLf
    s = s & "Inp_Trailing_MinChange_Points=5" & vbCrLf
    s = s & "Inp_BoundaryDetectionMode=0" & vbCrLf
    s = s & "" & vbCrLf
    s = s & "; --- Filter-e Ravand-e Ichimoku ---" & vbCrLf
    s = s & "Inp_IchimokuFilter_Enabled=true" & vbCrLf
    s = s & "Inp_Ichimoku_Tenkan=9" & vbCrLf
    s = s & "Inp_Ichimoku_Kijun=26" & vbCrLf
    s = s & "Inp_Ichimoku_SenkouB=52" & vbCrLf
    s = s & "Inp_Ichimoku_FlatThreshold_Points=0.0" & vbCrLf
    s = s & "" & vbCrLf
    s = s & "; --- Tanzimat-e Vorud-e Tatbighi (Version 2.3) ---" & vbCrLf
    s = s & "Inp_AdaptiveEntry_Enabled=true" & vbCrLf
    s = s & "Inp_AdaptiveMode=2" & vbCrLf
    s = s & "Inp_IchimokuMode=1" & vbCrLf
    s = s & "Inp_MinCandleBodyRatio=0.3" & vbCrLf
    s = s & "Inp_ExplosiveCandleBodyRatio=0.7" & vbCrLf
    s = s & "" & vbCrLf
    s = s & "; --- Tanzimat-e Tahlil-e Sakhtari ---" & vbCrLf
    s = s & "Inp_MA_Fast_Period=20" & vbCrLf
    s = s & "Inp_MA_Slow_Period=50" & vbCrLf
    s = s & "Inp_MA_Method=1" & vbCrLf
    s = s & "Inp_MA_Applied_Price=0" & vbCrLf
    s = s & "" & vbCrLf
    s = s & "; --- Modiriat-e Sarmaye (Vorud-e Ani/Enfejari) ---" & vbCrLf
    s = s & "Inp_Market_RR_Ratio=1.2" & vbCrLf
    s = s & "Inp_Market_PartialClosePercent=70.0" & vbCrLf
    s = s & "Inp_Market_BE_Buffer_Points=3" & vbCrLf
    s = s & "" & vbCrLf
    s = s & "; --- Tanzimat-e Stop Loss-e Tatbighi ---" & vbCrLf
    s = s & "Inp_AdaptiveSL_Enabled=true" & vbCrLf
    s = s & "" & vbCrLf
    
    ' Halghe baraye tamam-e 4 range
    Dim r As Integer
    For r = 1 To 4
        s = s & "; --- Tanzimat-e Range " & r & " ---" & vbCrLf
        s = s & "InpRange" & r & "_Enabled=false" & vbCrLf
        s = s & "InpRange" & r & "_Execution_Timeframe=16385" & vbCrLf
        s = s & "InpRange" & r & "_TrendFilter_Timeframe=16385" & vbCrLf
        s = s & "InpRange" & r & "_Start_Hour=0" & vbCrLf
        s = s & "InpRange" & r & "_Start_Minute=0" & vbCrLf
        s = s & "InpRange" & r & "_End_Hour=0" & vbCrLf
        s = s & "InpRange" & r & "_End_Minute=0" & vbCrLf
        s = s & "InpRange" & r & "_Placement_Mode=0" & vbCrLf
        s = s & "InpRange" & r & "_SL_Strategy=0" & vbCrLf
        s = s & "InpRange" & r & "_SL_Calc_Mode=0" & vbCrLf
        s = s & "InpRange" & r & "_Trailing_Mode=0" & vbCrLf
        s = s & "InpRange" & r & "_Cleanup_Hours=5" & vbCrLf
        s = s & "InpRange" & r & "_QualityFilter=1" & vbCrLf
        s = s & "" & vbCrLf
    Next r
    
    GetElementoTemplateString = s
End Function




































