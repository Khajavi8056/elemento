=AND(IF(AO2, AND(IF(AQ2=1, IF(AR2=0, AND(S2>1.1, IF(R2<=30, S2>=1.4, S2>=1.2)), S2>=10), TRUE), IF(AS2=0, AND(U2>1.1, IF(T2<=30, U2>=1.4, U2>=1.2)), TRUE)), TRUE), IF(AV2, AND(IF(BC2=1, IF(BD2=0, AND(S2>1.1, IF(R2<=30, S2>=1.4, S2>=1.2)), S2>=10), TRUE), IF(BE2=0, AND(U2>1.1, IF(T2<=30, U2>=1.4, U2>=1.2)), TRUE)), TRUE), IF(BG2, AND(IF(BK2=1, IF(BL2=0, AND(S2>1.1, IF(R2<=30, S2>=1.4, S2>=1.2)), S2>=10), TRUE), IF(BM2=0, AND(U2>1.1, IF(T2<=30, U2>=1.4, U2>=1.2)), TRUE)), TRUE), IF(BO2, AND(IF(BS2=1, IF(BT2=0, AND(S2>1.1, IF(R2<=30, S2>=1.4, S2>=1.2)), S2>=10), TRUE), IF(BU2=0, AND(U2>1.1, IF(T2<=30, U2>=1.4, U2>=1.2)), TRUE)), TRUE))





















' VBA Code Updated for Elemento EA
' Version 2.0 - Adapted by Gemini for Mohammad
' This macro reads a row from the optimization results and generates a .set file.

' تابع اصلی که با فشردن Alt+F8 اجرا می‌شود
Sub GenerateElementoSetFile()
    On Error GoTo ErrorHandler

    ' --- قدم ۱: تعریف مسیرها و چک کردن سلول انتخاب شده ---
    Dim desktopPath As String
    desktopPath = Environ("USERPROFILE") & "\Desktop"
    
    Dim elementoFolderPath As String
    elementoFolderPath = desktopPath & "\Elemento\"
    
    Dim outputFolderPath As String
    outputFolderPath = elementoFolderPath & "SetFiles\"

    ' ساخت پوشه‌ها در صورت عدم وجود
    If Dir(elementoFolderPath, vbDirectory) = "" Then MkDir elementoFolderPath
    If Dir(outputFolderPath, vbDirectory) = "" Then MkDir outputFolderPath

    ' چک کردن اینکه آیا یک سلول معتبر انتخاب شده است
    If ActiveCell Is Nothing Or ActiveCell.Row <= 1 Then
        MsgBox "خطا: لطفاً ابتدا یک سلول در یکی از ردیف‌های نتایج را انتخاب کنید.", vbCritical, "خطای انتخاب"
        Exit Sub
    End If

    Dim selectedRow As Long
    selectedRow = ActiveCell.Row
    
    Dim ws As Worksheet
    Set ws = ActiveSheet
    
    ' --- قدم ۲: خواندن داده‌های ردیف انتخاب شده اکسل در حافظه (Dictionary) ---
    Dim paramsFromExcel As Object
    Set paramsFromExcel = CreateObject("Scripting.Dictionary")
    paramsFromExcel.CompareMode = 1 ' جستجوی غیرحساس به حروف بزرگ و کوچک
    
    Dim lastCol As Long
    lastCol = ws.Cells(1, ws.Columns.Count).End(xlToLeft).Column
    Dim i As Long
    
    ' حلقه برای خواندن تمام ستون‌ها از ردیف انتخاب شده
    For i = 1 To lastCol
        Dim headerName As String
        headerName = CStr(ws.Cells(1, i).Value)
        If headerName <> "" Then
            paramsFromExcel(headerName) = CStr(ws.Cells(selectedRow, i).Value)
        End If
    Next i

    ' --- قدم ۳: ساخت محتوای فایل .set بر اساس قالب و جایگزینی مقادیر ---
    Dim templateString As String
    templateString = GetElementoTemplateString() ' گرفتن قالب کامل از تابع کمکی
    
    Dim lines() As String
    lines = Split(templateString, vbCrLf) ' شکستن قالب به خطوط مجزا
    
    Dim finalContent As String
    finalContent = "; Automatically Generated by Gemini for Mohammad's Elemento EA" & vbCrLf
    finalContent = finalContent & "; Source Pass Number: " & paramsFromExcel("Pass") & vbCrLf & vbCrLf
    
    Dim line As Variant
    Dim paramName As String
    
    ' حلقه برای عبور از هر خط قالب
    For Each line In lines
        If InStr(line, "=") > 0 And Left(line, 1) <> ";" Then ' اگر خط حاوی پارامتر باشد
            paramName = Trim(Split(line, "=")(0))
            
            ' چک کردن اینکه آیا این پارامتر در نتایج اکسل ما وجود دارد یا نه
            If paramsFromExcel.Exists(paramName) Then
                ' اگر وجود داشت، مقدار آن را از اکسل جایگزین کن
                finalContent = finalContent & paramName & "=" & paramsFromExcel(paramName) & vbCrLf
            Else
                ' اگر وجود نداشت، همان خط پیش‌فرض قالب را نگه دار
                finalContent = finalContent & line & vbCrLf
            End If
        Else
            ' خطوط خالی یا کامنت‌ها را همانطور که هست، اضافه کن
            finalContent = finalContent & line & vbCrLf
        End If
    Next line
    
    ' --- قدم ۴: ذخیره فایل .set نهایی ---
    Dim outputFilePath As String
    outputFilePath = outputFolderPath & "Pass_" & paramsFromExcel("Pass") & ".set"

    Dim fileNum As Integer
    fileNum = FreeFile
    Open outputFilePath For Output As #fileNum
    Print #fileNum, finalContent
    Close #fileNum
    
    MsgBox "فایل .set برای پاس شماره " & paramsFromExcel("Pass") & " با موفقیت در دسکتاپ شما (پوشه Elemento\SetFiles) ساخته شد.", vbInformation, "عملیات موفق"
    Exit Sub

ErrorHandler:
    MsgBox "یک خطای پیش‌بینی نشده رخ داد: " & vbCrLf & Err.Description, vbCritical, "خطا"
End Sub

' این تابع، قالب کامل و پیش‌فرض فایل .set برای اکسپرت Elemento را نگهداری می‌کند
Private Function GetElementoTemplateString() As String
    Dim s As String
    s = ""
    s = s & "; --- تنظیمات عمومی ---" & vbCrLf
    s = s & "InpBaseMagicNumber=123456" & vbCrLf
    s = s & "InpRiskPercent=1.0" & vbCrLf
    s = s & "InpDebugMode=true" & vbCrLf
    s = s & "Inp_Invalidation_Mode=0" & vbCrLf
    s = s & "Inp_Confirmation_Strategy=1" & vbCrLf
    s = s & "Inp_Confirmation_Timeout=3" & vbCrLf
    s = s & "Inp_PriceConfirmation_Enabled=true" & vbCrLf
    s = s & "Inp_MinRangePoints=50" & vbCrLf
    s = s & "Inp_MaxRangePoints=1500" & vbCrLf
    s = s & "Inp_Placement_ATR_Period=14" & vbCrLf
    s = s & "Inp_Placement_ATR_Multiplier=1.0" & vbCrLf
    s = s & "Inp_Placement_Percent_Value=0.5" & vbCrLf
    s = s & "Inp_SL_ATR_Period=14" & vbCrLf
    s = s & "Inp_SL_ATR_Multiplier=1.5" & vbCrLf
    s = s & "Inp_Trailing_ATR_Period=14" & vbCrLf
    s = s & "Inp_Trailing_ATR_Multiplier=2.0" & vbCrLf
    s = s & "Inp_RR_Ratio=1.5" & vbCrLf
    s = s & "Inp_PartialClosePercent=50.0" & vbCrLf
    s = s & "Inp_Pullback_StopBuffer_Points=5" & vbCrLf
    s = s & "Inp_BE_Buffer_Points=5" & vbCrLf
    s = s & "Inp_Trailing_MinChange_Points=5" & vbCrLf
    s = s & "Inp_BoundaryDetectionMode=0" & vbCrLf
    s = s & "" & vbCrLf
    s = s & "; --- فیلتر روند ایچیموکو ---" & vbCrLf
    s = s & "Inp_IchimokuFilter_Enabled=true" & vbCrLf
    s = s & "Inp_Ichimoku_Tenkan=9" & vbCrLf
    s = s & "Inp_Ichimoku_Kijun=26" & vbCrLf
    s = s & "Inp_Ichimoku_SenkouB=52" & vbCrLf
    s = s & "Inp_Ichimoku_FlatThreshold_Points=0.0" & vbCrLf
    s = s & "" & vbCrLf
    s = s & "; --- تنظیمات ورود تطبیقی (نسخه 2.3) ---" & vbCrLf
    s = s & "Inp_AdaptiveEntry_Enabled=true" & vbCrLf
    s = s & "Inp_AdaptiveMode=2" & vbCrLf
    s = s & "Inp_IchimokuMode=1" & vbCrLf
    s = s & "Inp_MinCandleBodyRatio=0.3" & vbCrLf
    s = s & "Inp_ExplosiveCandleBodyRatio=0.7" & vbCrLf
    s = s & "" & vbCrLf
    s = s & "; --- تنظیمات تحلیل ساختاری ---" & vbCrLf
    s = s & "Inp_MA_Fast_Period=20" & vbCrLf
    s = s & "Inp_MA_Slow_Period=50" & vbCrLf
    s = s & "Inp_MA_Method=1" & vbCrLf
    s = s & "Inp_MA_Applied_Price=0" & vbCrLf
    s = s & "" & vbCrLf
    s = s & "; --- مدیریت سرمایه (ورود آنی/انفجاری) ---" & vbCrLf
    s = s & "Inp_Market_RR_Ratio=1.2" & vbCrLf
    s = s & "Inp_Market_PartialClosePercent=70.0" & vbCrLf
    s = s & "Inp_Market_BE_Buffer_Points=3" & vbCrLf
    s = s & "" & vbCrLf
    s = s & "; --- تنظیمات استاپ‌لاس تطبیقی ---" & vbCrLf
    s = s & "Inp_AdaptiveSL_Enabled=true" & vbCrLf
    s = s & "" & vbCrLf
    
    ' Loop for all 4 ranges
    Dim r As Integer
    For r = 1 To 4
        s = s & "; --- تنظیمات رنج " & r & " ---" & vbCrLf
        s = s & "InpRange" & r & "_Enabled=false" & vbCrLf
        s = s & "InpRange" & r & "_Execution_Timeframe=16385" & vbCrLf
        s = s & "InpRange" & r & "_TrendFilter_Timeframe=16385" & vbCrLf
        s = s & "InpRange" & r & "_Start_Hour=0" & vbCrLf
        s = s & "InpRange" & r & "_Start_Minute=0" & vbCrLf
        s = s & "InpRange" & r & "_End_Hour=0" & vbCrLf
        s = s & "InpRange" & r & "_End_Minute=0" & vbCrLf
        s = s & "InpRange" & r & "_Placement_Mode=0" & vbCrLf
        s = s & "InpRange" & r & "_SL_Strategy=0" & vbCrLf
        s = s & "InpRange" & r & "_SL_Calc_Mode=0" & vbCrLf
        s = s & "InpRange" & r & "_Trailing_Mode=0" & vbCrLf
        s = s & "InpRange" & r & "_Cleanup_Hours=5" & vbCrLf
        s = s & "InpRange" & r & "_QualityFilter=1" & vbCrLf
        s = s & "" & vbCrLf
    Next r
    
    GetElementoTemplateString = s
End Function




























