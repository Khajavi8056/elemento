// به‌روزرسانی در کندل جدید: اجرای ماشین حالت (نسخه نهایی و اصلاح شده)
void CRange::UpdateOnNewBar()
{
   // ==================== راه حل قطعی اینجا قرار دارد ====================
   // قدم اول: قبل از هر کاری و فارغ از هر حالتی، زمان پاکسازی رو چک کن
   if (m_cleanupTime != 0 && TimeCurrent() >= m_cleanupTime && !m_isCleanedForThisCycle)
   {
       CLogger::Log("زمان پاکسازی فرا رسید (حالت فعلی: " + EnumToString(m_currentState) + "). اجرای پاکسازی نرم.", m_rangeIndex);
       
       // مستقیماً SoftCleanup رو اجرا میکنیم
       SoftCleanup();
       
       // حالت رو به IDLE تغییر میدیم تا برای روز بعد آماده بشه
       m_currentState = RANGE_IDLE;
       
       // با return از تابع خارج میشیم تا هیچ منطق دیگه‌ای در این کندل اجرا نشه
       return;
   }
   // =================================================================

   // لاگ ورود به تابع برای ردیابی
   CLogger::Log("------ در حالت " + EnumToString(m_currentState) + " ------", m_rangeIndex);

   // حالا بقیه منطق ماشین حالت اجرا میشه
   switch(m_currentState)
   {
      // ... (تمام case های دیگر بدون تغییر)
      case RANGE_TRADE_ACTIVE:
         // این بخش دیگه فقط برای لاگ زدنه، چون پاکسازی در بالای تابع انجام میشه
         CLogger::Log("معامله فعال است. منتظر پاکسازی.", m_rangeIndex);
         break;
      // ...
   }
}
