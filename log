// به‌روزرسانی در کندل جدید: اجرای ماشین حالت (نسخه اصلاح شده با اولویت پاکسازی)
void CRange::UpdateOnNewBar()
{
   // ==================== شروع اصلاحیه ====================
   // قدم اول: قبل از هر کاری، زمان پاکسازی رو چک کن
   if (m_cleanupTime != 0 && TimeCurrent() >= m_cleanupTime && !m_isCleanedForThisCycle)
   {
       CLogger::Log("زمان پاکسازی فرا رسید (" + TimeToString(m_cleanupTime) + "). اجرای پاکسازی نرم.", m_rangeIndex);
       // مستقیماً SoftCleanup رو اجرا میکنیم و حالت رو به IDLE تغییر میدیم
       SoftCleanup();
       m_currentState = RANGE_IDLE;
       // با return از تابع خارج میشیم تا هیچ منطق معاملاتی دیگه‌ای در این کندل اجرا نشه
       return;
   }
   // ==================== پایان اصلاحیه =====================

   // لاگ ورود به تابع برای ردیابی
   CLogger::Log("------ در حالت " + EnumToString(m_currentState) + " ------", m_rangeIndex);

   // سوئیچ بر اساس حالت فعلی برای اجرای تابع مربوطه
   switch(m_currentState)
   {
      case RANGE_IDLE:
      {
         // ... (بقیه کد بدون تغییر باقی می‌مونه)
         datetime currentTime = TimeCurrent();
         datetime startTime, endTime;
         if(CTimeHelper::CalculateRangeTimes(m_startHour, m_startMinute, m_endHour, m_endMinute, startTime, endTime))
         {
            if(currentTime >= startTime && currentTime < endTime)
            {
               CLogger::Log("زمان رنج فرا رسید. انتقال به RANGE_IDENTIFYING.", m_rangeIndex);
               m_currentState = RANGE_IDENTIFYING;
            }
         }
         break;
      }
      case RANGE_IDENTIFYING:
         IdentifyAndValidateRange();
         break;
      case RANGE_ARMED:
         WaitForBreakerCandle();
         break;
      case AWAITING_CONFIRMATION:
         ProcessEntryAttempt();
         break;
      case RANGE_TRADE_ACTIVE:
         CLogger::Log("معامله فعال است. منتظر پاکسازی.", m_rangeIndex);
         break;
      case RANGE_EXPIRED:
         SoftCleanup();
         m_currentState = RANGE_IDLE;
         break;
   }

   // تابع CheckCleanup() از انتهای تابع حذف میشه چون منطقش به بالای تابع منتقل شد.
}
